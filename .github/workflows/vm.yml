name: Android Studio VM (Browser noVNC)

on:
  workflow_dispatch:

jobs:
  vm:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Update system
      run: sudo apt update

    - name: Install desktop, VNC, noVNC
      run: |
        sudo apt install -y xfce4 xfce4-goodies tightvncserver dbus-x11 git websockify
        git clone https://github.com/novnc/noVNC.git
        git clone https://github.com/novnc/websockify.git

    - name: Setup VNC server
      run: |
        mkdir -p ~/.vnc
        echo -e "password\npassword\nn" | vncpasswd
        echo '#!/bin/sh\nunset SESSION_MANAGER\nunset DBUS_SESSION_BUS_ADDRESS\nexec startxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        vncserver -kill :1 || true
        vncserver :1

    - name: Start noVNC
      run: |
        cd noVNC
        ./utils/novnc_proxy --vnc localhost:5901 --listen 6080 &

    - name: Install ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xvzf ngrok-v3-stable-linux-amd64.tgz
        sudo mv ngrok /usr/local/bin
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Expose noVNC via ngrok
      run: ngrok http 6080

    - name: Install Java
      run: sudo apt install -y openjdk-17-jdk

    - name: Install Android Studio
      run: |
        wget https://redirector.gvt1.com/edgedl/android/studio/ide-zips/2024.1.1.12/android-studio-2024.1.1.12-linux.tar.gz
        tar -xvzf android-studio-*-linux.tar.gz
        sudo mv android-studio /opt/android-studio

    - name: Start Android Studio
      run: |
        export DISPLAY=:1
        /opt/android-studio/bin/studio.sh &

