name: Android Studio VM (Browser noVNC)

on:
  workflow_dispatch:

jobs:
  vm:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Update system
      run: sudo apt update

    - name: Install desktop, VNC, noVNC
      run: |
        sudo apt install -y xfce4 xfce4-goodies tightvncserver dbus-x11 git websockify
        git clone https://github.com/novnc/noVNC.git
        git clone https://github.com/novnc/websockify.git

   - name: Setup VNC correctly
       run: |
          mkdir -p ~/.vnc
          echo -e "password\npassword\nn" | vncpasswd
          cat << 'EOF' > ~/.vnc/xstartup
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          exec startxfce4 &
          EOF
          chmod +x ~/.vnc/xstartup
          vncserver -kill :1 || true
          vncserver -localhost no :1

    - name: Start noVNC
      run: |
        cd noVNC
        ./utils/novnc_proxy --vnc 0.0.0.0:5901 --listen 6080 &

    - name: Install ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xvzf ngrok-v3-stable-linux-amd64.tgz
        sudo mv ngrok /usr/local/bin
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Expose noVNC via ngrok
      run: ngrok http 6080

